<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMS Media Hive | Blog & Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Your existing styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Oswald:wght@200..700&display=swap');
        :root { --primary-color: #eab308; --dark-bg: #0d0d0d; --mid-bg: #1a1a1a; --text-light: #f3f4f6; --text-muted: #9ca3af; }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--text-light); overflow-x: hidden; padding-top: 6rem; }
        .oswald { font-family: 'Oswald', sans-serif; }
        
        /* Corrected CSS path */
        #blog-hero { background-image: url('src/pretty.jpg'); background-size: cover; background-position: center; }
        
        .post-card { background-color: #1a1a1a; }
        /* Style for the temporary video element used for thumbnail generation */
        .thumbnail-generator-video { position: absolute; top: -9999px; left: -9999px; width: 320px; height: auto; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="bg-transparent absolute top-0 left-0 w-full z-20 pt-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-start">
            <div class="text-xl font-extrabold tracking-widest text-white oswald">
                <a href="index.html">SIMS Media Hive</a>
            </div>

            <div class="hidden md:block text-right text-xs text-gray-400">
                <p>gds.simshive@gmail.com</p>
                <p>+91 7981 951 879</p>
            </div>
            
            <button id="mobile-menu-button" class="md:hidden p-2 text-yellow-500 hover:text-white transition duration-300 z-30">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
        </div>

        <nav class="hidden md:flex justify-center mt-4">
            <ul class="flex space-x-8 text-sm font-medium uppercase tracking-widest text-gray-300">
                <li><a href="/index.html" class="hover:text-yellow-500 transition duration-300">Home</a></li>
                <li><a href="/index.html#focus" class="hover:text-yellow-500 transition duration-300">Focus</a></li>
                <li><a href="/index.html#work" class="hover:text-yellow-500 transition duration-300">Projects</a></li>
                <li><a href="/members.html" class="hover:text-yellow-500 transition duration-300">Members</a></li>
                
                <li><a href="/blog.html" class="text-yellow-500 transition duration-300">Blog</a></li>
                
                <li><a href="/gallery.html" class="hover:text-yellow-500 transition duration-300">Gallery</a></li>
                <li><a href="/contact.html" class="hover:text-yellow-500 transition duration-300">Join Us</a></li>
            
            </ul>
        </nav>

        <nav id="mobile-menu" class="hidden md:hidden fixed top-0 left-0 w-full h-full bg-gray-950/95 backdrop-blur-sm pt-24 pb-8 overflow-y-auto z-10">
            <ul class="flex flex-col items-center space-y-8 text-xl font-semibold uppercase tracking-widest text-gray-300">
                <li><a href="/index.html" class="hover:text-yellow-500 transition duration-300 block py-2">Home</a></li>
                <li><a href="/index.html#focus" class="hover:text-yellow-500 transition duration-300 block py-2">Focus</a></li>
                <li><a href="/index.html#work" class="hover:text-yellow-500 transition duration-300 block py-2">Projects</a></li>
                <li><a href="/members.html" class="hover:text-yellow-500 transition duration-300 block py-2">Members</a></li>
                
                <li><a href="/blog.html" class="text-yellow-500 transition duration-300 block py-2">Blog</a></li>
                
                <li><a href="/gallery.html" class="hover:text-yellow-500 transition duration-300 block py-2">Gallery</a></li>
                <li><a href="/contact.html" class="hover:text-yellow-500 transition duration-300 block py-2">Join Us</a></li>
            </ul>
        </nav>
    </header>

    <main class="flex-grow">
        <section id="blog-hero" class="relative py-24 md:py-40 flex items-center">
            <div class="absolute inset-0 bg-black bg-opacity-70"></div>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-0 text-center"><p class="text-sm text-yellow-500 uppercase tracking-widest mb-4">Insights, Tutorials, and News</p><h1 class="text-5xl sm:text-7xl font-bold leading-tight text-white oswald mb-4"> The Hive Feed </h1><p class="text-xl text-gray-300 max-w-3xl mx-auto"> Stay updated with our latest productions, technical tips, and media industry commentary. </p></div>
        </section>

        <section class="bg-gray-950 py-20 md:py-32">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl font-bold text-white oswald mb-12">Latest Articles</h2>
                <div id="blog-posts-container" class="grid grid-cols-1 md:grid-cols-3 gap-10">
                    <p class="text-gray-400 col-span-full text-center">Loading articles...</p>
                </div>
            </div>
        </section>
    </main>

   <footer class="bg-gray-900 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                
                <div>
                    <h3 class="text-xl font-extrabold tracking-widest text-white oswald mb-4">
                        <a href="index.html">SIMS Media Hive</a>
                    </h3>
                    <p class="text-gray-400 text-sm mb-4 max-w-xs">
                        Your creative partner in digital media production, storytelling, and impactful content.
                    </p>
                    <div class="space-y-2 text-sm text-gray-400">
                        <p class="flex items-center">
                            <i data-lucide="mail" class="inline w-4 h-4 mr-2 text-yellow-500 shrink-0"></i>
                            <span>gds.simshive@gmail.com</span>
                        </p>
                        <p class="flex items-center">
                            <i data-lucide="phone" class="inline w-4 h-4 mr-2 text-yellow-500 shrink-0"></i>
                            <span>+91 7981 951 879</span>
                        </p>
                    </div>
                </div>

                <div>
                    <h4 class="text-lg font-semibold text-white oswald tracking-wider mb-4">Quick Links</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="/index.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Home</a></li>
                        <li><a href="/index.html#work" class="text-gray-400 hover:text-yellow-500 transition duration-300">Projects</a></li>
                        <li><a href="/members.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Members</a></li>
                        
                        <li><a href="/login.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Member Login</a></li>
                        
                        <li><a href="/blog.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Blog</a></li>
                        <li><a href="/gallery.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Gallery</a></li>
                        <li><a href="/contact.html" class="text-gray-400 hover:text-yellow-500 transition duration-300">Join Us</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold text-white oswald tracking-wider mb-4">Follow Us</h4>
                    <p class="text-sm text-gray-400 mb-4">Stay connected on our social channels.</p>
                    
                    <div class="flex space-x-4 justify-center md:justify-start">
                        <a href="#" aria-label="Instagram" class="text-gray-400 hover:text-yellow-500 transition duration-300">
                            <i data-lucide="instagram" class="w-6 h-6"></i>
                        </a>
                        <a href="#" aria-label="YouTube" class="text-gray-400 hover:text-yellow-500 transition duration-300">
                            <i data-lucide="youtube" class="w-6 h-6"></i>
                        </a>
                        <a href="#" aria-label="Facebook" class="text-gray-400 hover:text-yellow-500 transition duration-300">
                            <i data-lucide="facebook" class="w-6 h-6"></i>
                        </a>
                        <a href="#" aria-label="LinkedIn" class="text-gray-400 hover:text-yellow-500 transition duration-3D00">
                            <i data-lucide="linkedin" class="w-6 h-6"></i>
                        </a>
                    </div>
                </div>

            </div>

            <div class="mt-16 pt-8 border-t border-gray-800 text-center text-sm text-gray-500">
                <p>&copy; 2025 SIMS Media Hive. All Rights Reserved. Designed by <a href="https://dcagency.in" target="_blank" class="hover:text-yellow-500 transition">Darion Creative Agency.</a></p>
            </div>

        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- Mobile Menu Toggle Logic ---
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = menuButton.querySelector('i');

        menuButton.addEventListener('click', () => {
            // Toggle the 'hidden' class on the mobile menu
            mobileMenu.classList.toggle('hidden');
            
            // Toggle the visibility of the main body content (to prevent scrolling behind the menu)
            document.body.classList.toggle('overflow-hidden');

            // Toggle the icon (Menu <-> X)
            const isMenuOpen = !mobileMenu.classList.contains('hidden');
            if (isMenuOpen) {
                // Menu is open, show 'x' icon
                menuIcon.setAttribute('data-lucide', 'x');
            } else {
                // Menu is closed, show 'menu' icon
                menuIcon.setAttribute('data-lucide', 'menu');
            }
            lucide.createIcons(); // Re-render the icon
        });

        // Close the mobile menu when a link is clicked
        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                // Close the menu
                mobileMenu.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                
                // Reset the icon
                menuIcon.setAttribute('data-lucide', 'menu');
                lucide.createIcons();
            });
        });
    </script>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://gswdqdsviqrzsoahxapc.supabase.co/'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdzd2RxZHN2aXFyenNvYWh4YXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODM5NzcsImV4cCI6MjA3NjQ1OTk3N30.JFF6NFIdqZAE9ioHeMdfIVpN84UtN_Z0K2pZYodlpZY';

        // --- INITIALIZATION ---
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const postsContainer = document.getElementById('blog-posts-container');
        const defaultPlaceholder = 'https://placehold.co/600x400/1c1917/f59e0b?text=IMAGE';
        
        // --- Helper Functions ---
        function isVideoUrl(url) {
            if (!url) return false;
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv'];
            const lowerUrl = url.toLowerCase();
            return videoExtensions.some(ext => lowerUrl.endsWith(ext));
        }

        function extractYouTubeVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
                /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        async function generateVideoThumbnail(videoUrl) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                let resolved = false; 
                video.classList.add('thumbnail-generator-video');
                video.muted = true;
                video.playsInline = true;
                video.preload = 'metadata';
                video.crossOrigin = 'anonymous'; 

                const onError = (e) => {
                    if (resolved) return;
                    console.warn(`Thumbnail generation failed for ${videoUrl}:`, e);
                    cleanup();
                    resolve(null); 
                };

                const cleanup = () => {
                    video.removeEventListener('loadeddata', onLoadedData);
                    video.removeEventListener('seeked', onSeeked);
                    video.removeEventListener('error', onError);
                    video.removeEventListener('stalled', onError);
                     if (video.parentNode) {
                         video.parentNode.removeChild(video);
                     }
                };

                 const timeoutId = setTimeout(() => {
                     if (resolved) return;
                     console.warn(`Thumbnail generation timed out for ${videoUrl}`);
                     cleanup();
                     resolve(null);
                 }, 7000); 

                const onLoadedData = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    video.currentTime = Math.min(1, video.duration / 2);
                };

                const onSeeked = () => {
                     if (resolved) return;
                    try {
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolved = true;
                        clearTimeout(timeoutId);
                        cleanup();
                        resolve(dataUrl);
                    } catch (drawError) {
                         onError(drawError);
                    }
                };

                video.addEventListener('loadeddata', onLoadedData);
                video.addEventListener('seeked', onSeeked);
                video.addEventListener('error', onError);
                video.addEventListener('stalled', onError);

                video.src = videoUrl;
                video.load(); 
            });
        }

        // --- Helper Function to Get Average Rating with Advanced Error Handling ---
        async function getAverageRating(postId) {
            // Input validation
            if (!postId || typeof postId !== 'number' || postId <= 0) {
                console.warn("Invalid postId provided to getAverageRating:", postId);
                return 0;
            }

            try {
                const { data, error } = await _supabase
                    .from('blogPosts')
                    .select('average_rating')
                    .eq('id', postId)
                    .single();

                if (error) {
                    // Handle specific Supabase errors
                    if (error.code === 'PGRST116') {
                        console.warn(`Post ${postId} not found for rating fetch`);
                        return 0;
                    }
                    throw error;
                }

                // Validate returned data
                const rating = data?.average_rating;
                if (typeof rating !== 'number' || rating < 0 || rating > 5) {
                    console.warn(`Invalid rating value for post ${postId}:`, rating);
                    return 0;
                }

                return rating;
            } catch (error) {
                console.error(`Error fetching rating for post ${postId}:`, error);
                // Return fallback value instead of throwing to prevent UI breakage
                return 0;
            }
        }

        // --- Function to Generate Star Display with Validation ---
        function generateStars(rating) {
            // Input validation
            if (typeof rating !== 'number' || isNaN(rating)) {
                console.warn("Invalid rating provided to generateStars:", rating);
                rating = 0;
            }

            // Clamp rating between 0 and 5
            rating = Math.max(0, Math.min(5, rating));

            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            let stars = '';

            // Generate full stars
            for (let i = 0; i < fullStars; i++) {
                stars += '<i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current" aria-label="Full star"></i>';
            }

            // Generate half star if needed
            if (halfStar) {
                stars += '<i data-lucide="star-half" class="w-4 h-4 text-yellow-500 fill-current" aria-label="Half star"></i>';
            }

            // Generate empty stars
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i data-lucide="star" class="w-4 h-4 text-gray-500" aria-label="Empty star"></i>';
            }

            return stars;
        }

        // --- SUPABASE BLOG POST LOGIC with Advanced Error Handling ---
        async function loadBlogPosts() {
            // Validate DOM elements
            if (!postsContainer) {
                console.error("Blog posts container not found!");
                return;
            }

            // Set loading state
            postsContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Loading articles...</p>';

            try {
                // Fetch blog posts with timeout and retry logic
                const { data, error } = await _supabase
                    .from('blogPosts')
                    .select('id, title, author, imageUrl, created_at')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw new Error(`Database query failed: ${error.message}`);
                }

                // Clear loading state
                postsContainer.innerHTML = '';

                // Handle empty results
                if (!data || data.length === 0) {
                    postsContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">No articles have been published yet.</p>';
                    return;
                }

                // Process posts with error handling for each post
                const postPromises = data.map(async (post, index) => {
                    try {
                        // Validate post data
                        if (!post || !post.id || !post.title) {
                            console.warn(`Invalid post data at index ${index}:`, post);
                            return ''; // Skip invalid posts
                        }

                        // Format date safely
                        let postDate = 'Unknown date';
                        try {
                            postDate = new Date(post.created_at).toLocaleDateString('en-US', {
                                month: 'short', day: 'numeric', year: 'numeric'
                            });
                        } catch (dateError) {
                            console.warn(`Invalid date for post ${post.id}:`, post.created_at);
                        }

                        // Handle image processing
                        let imageSource = defaultPlaceholder;
                        if (post.imageUrl) {
                            try {
                                // Always check for YouTube URL first, regardless of category
                                if (post.imageUrl.includes('youtube.com') || post.imageUrl.includes('youtu.be')) {
                                    // Extract YouTube video ID and create thumbnail URL
                                    const videoId = extractYouTubeVideoId(post.imageUrl);
                                    if (videoId) {
                                        imageSource = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                                    } else {
                                        imageSource = defaultPlaceholder;
                                    }
                                } else if (isVideoUrl(post.imageUrl)) {
                                    // For non-YouTube videos, generate thumbnail
                                    const thumbnailUrl = await generateVideoThumbnail(post.imageUrl);
                                    if (thumbnailUrl) {
                                        imageSource = thumbnailUrl;
                                    } else {
                                        console.warn(`Using placeholder for video: ${post.title}`);
                                    }
                                } else {
                                    // For photos and other non-video items
                                    imageSource = post.imageUrl;
                                }
                            } catch (imageError) {
                                console.warn(`Error processing image for post ${post.id}:`, imageError);
                                // Keep default placeholder
                            }
                        }

                        // Get rating with error handling
                        const avgRating = await getAverageRating(post.id);
                        const stars = generateStars(avgRating);

                        // Sanitize content for HTML
                        const safeTitle = (post.title || 'Untitled').replace(/[<>]/g, '');
                        const safeAuthor = (post.author || 'Unknown').replace(/[<>]/g, '');

                        return `
                            <a href="post.html?id=${post.id}" class="block post-card rounded-lg overflow-hidden transition duration-300 hover:shadow-yellow-500/20 shadow-xl">
                                <img src="${imageSource}"
                                     onerror="this.onerror=null;this.src='${defaultPlaceholder}';"
                                     alt="Preview for ${safeTitle}" class="w-full h-48 object-cover bg-gray-700">
                                <div class="p-6">
                                    <h3 class="text-xl font-bold text-white oswald mb-2 hover:text-yellow-400 transition duration-200">
                                        ${safeTitle}
                                    </h3>
                                    <p class="text-sm text-gray-400">
                                        By ${safeAuthor}
                                    </p>
                                    <div class="flex items-center mt-2">
                                        <div class="flex items-center mr-2">${stars}</div>
                                        <span class="text-xs text-gray-500">(${avgRating.toFixed(1)})</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-4">${postDate}</p>
                                </div>
                            </a>
                        `;
                    } catch (postError) {
                        console.error(`Error processing post ${post?.id || index}:`, postError);
                        return ''; // Skip problematic posts
                    }
                });

                // Wait for all posts to be processed
                const postHTMLArray = await Promise.allSettled(postPromises);
                const validPosts = postHTMLArray
                    .filter(result => result.status === 'fulfilled' && result.value)
                    .map(result => result.value);

                if (validPosts.length === 0) {
                    postsContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Unable to load articles. Please try again later.</p>';
                } else {
                    postsContainer.innerHTML = validPosts.join('');
                }

            } catch(error) {
                console.error("Error loading blog posts:", error);
                postsContainer.innerHTML = `<p class="text-center text-red-500 text-lg col-span-full">Could not load articles. Please check your connection and try again.</p>`;
            } finally {
                // Always re-render icons
                try {
                    lucide.createIcons();
                } catch (iconError) {
                    console.warn("Error rendering icons:", iconError);
                }
            }
        }

        // --- Run Blog Post Logic ---
        // This runs separately from the menu script.
        loadBlogPosts();
    </script>
</body>
</html>
