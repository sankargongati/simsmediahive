<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMS Media Hive | Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Oswald:wght@200..700&display=swap');
        :root { --primary-color: #eab308; --dark-bg: #0d0d0d; --mid-bg: #1a1a1a; --text-light: #f3f4f6; --text-muted: #9ca3af; }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--text-light); overflow-x: hidden; }
        .oswald { font-family: 'Oswald', sans-serif; }

        /* Styles for the lightbox modal */
        #lightbox-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 85vh; }
        .lightbox-content img, .lightbox-content video { width: auto; height: auto; max-width: 100%; max-height: 85vh; display: block; margin: 0 auto; border: 2px solid #374151; border-radius: 4px; }
        #lightbox-close { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; line-height: 1; z-index: 1010; }
        #lightbox-close:hover, #lightbox-close:focus { color: #bbb; text-decoration: none; }
        #lightbox-caption { margin: auto; display: block; width: 80%; max-width: 700px; text-align: center; color: #ccc; padding: 10px 0; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 1rem; }

         /* Style for Video Icon Overlay */
         .video-overlay-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 48px; height: 48px; background-color: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0.8; transition: opacity 0.3s ease; }
         .gallery-item:hover .video-overlay-icon { opacity: 1; }
         .video-overlay-icon svg { color: white; width: 24px; height: 24px; }
         /* Style for temporary video element */
        .thumbnail-generator-video { position: absolute; top: -9999px; left: -9999px; width: 320px; height: auto; }
        /* Ensure hidden items stay hidden */
         .gallery-item.hidden { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-transparent absolute top-0 left-0 w-full z-20 pt-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-start">
            <div class="text-xl font-extrabold tracking-widest text-white oswald">
                SIMS Media Hive
            </div>

            <div class="hidden md:block text-right text-xs text-gray-400">
                <p>gds.simshive@gmail.com</p>
                <p>+91 7981 951 879</p>
            </div>
            
            <button id="mobile-menu-button" class="md:hidden p-2 text-yellow-500 hover:text-white transition duration-300 z-30">
                <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
        </div>

        <nav class="hidden md:flex justify-center mt-4">
            <ul class="flex space-x-8 text-sm font-medium uppercase tracking-widest text-gray-300">
                <li><a href="#" class="hover:text-yellow-500 transition duration-300">Home</a></li>
                <li><a href="#focus" class="hover:text-yellow-500 transition duration-300">Focus</a></li>
                <li><a href="#work" class="hover:text-yellow-500 transition duration-300">Projects</a></li>
                <li><a href="/members.html" class="hover:text-yellow-500 transition duration-300">Members</a></li>
                <li><a href="/blog.html" class="hover:text-yellow-500 transition duration-300">Blog</a></li>
                <li><a href="/gallery.html" class="hover:text-yellow-500 transition duration-300">Gallery</a></li>
                <li><a href="/contact.html" class="hover:text-yellow-500 transition duration-300">Join Us</a></li>
            
            </ul>
        </nav>

        <nav id="mobile-menu" class="hidden md:hidden fixed top-0 left-0 w-full h-full bg-gray-950/95 backdrop-blur-sm pt-24 pb-8 overflow-y-auto z-10">
            <ul class="flex flex-col items-center space-y-8 text-xl font-semibold uppercase tracking-widest text-gray-300">
                <li><a href="#" class="hover:text-yellow-500 transition duration-300 block py-2">Home</a></li>
                <li><a href="#focus" class="hover:text-yellow-500 transition duration-300 block py-2">Focus</a></li>
                <li><a href="#work" class="hover:text-yellow-500 transition duration-300 block py-2">Projects</a></li>
                <li><a href="/members.html" class="hover:text-yellow-500 transition duration-300 block py-2">Members</a></li>
                <li><a href="/blog.html" class="hover:text-yellow-500 transition duration-300 block py-2">Blog</a></li>
                <li><a href="/gallery.html" class="hover:text-yellow-500 transition duration-300">Gallery</a></li>
                <li><a href="/contact.html" class="hover:text-yellow-500 transition duration-300 block py-2">Join Us</a></li>
            </ul>
        </nav>
    </header>

    <!-- Page Header Section -->
    <section class="bg-black pt-40 pb-20 md:pb-32 border-b border-gray-800">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center"><p class="text-sm text-yellow-500 uppercase tracking-widest mb-2">Our Work</p><h1 class="text-4xl sm:text-6xl font-bold text-white oswald">Creative Gallery</h1><p class="text-lg text-gray-400 max-w-3xl mx-auto mt-6">A visual journey through our projects.</p></div>
    </section>

    <!-- Gallery Grid Section -->
    <section id="gallery-grid-section" class="bg-gray-950 py-20 md:py-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="filter-buttons" class="flex justify-center items-center space-x-4 mb-12">
                <button class="filter-btn px-6 py-2 font-semibold uppercase tracking-wider text-sm rounded-full transition duration-300 bg-yellow-500 text-black" data-filter="all">All</button>
                <button class="filter-btn px-6 py-2 font-semibold uppercase tracking-wider text-sm rounded-full transition duration-300 bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white" data-filter="photo">Photos</button>
                <button class="filter-btn px-6 py-2 font-semibold uppercase tracking-wider text-sm rounded-full transition duration-300 bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white" data-filter="video">Videos</button>
            </div>
            <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <p id="loading-message" class="text-gray-400 col-span-full text-center">Loading gallery...</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 py-10 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500"><p>&copy; 2025 SIMS Media Hive. All Rights Reserved.</p></div>
    </footer>

    <!-- Lightbox Modal Structure -->
    <div id="lightbox-modal" class="cursor-pointer">
        <span id="lightbox-close">&times;</span>
        <div id="lightbox-media-content" class="lightbox-content">
            <!-- Image or Video will be loaded here -->
        </div>
        <div id="lightbox-caption"></div>
    </div>


    <!-- SCRIPT (Updated for Video Thumbnails) -->
    <script type="module">
        lucide.createIcons();
        // --- Mobile Menu Logic ---
        const menuButton = document.getElementById('mobile-menu-button'); const mobileMenu = document.getElementById('mobile-menu'); if (menuButton) { const menuIcon = menuButton.querySelector('i'); if (mobileMenu && menuIcon) { menuButton.addEventListener('click', () => { mobileMenu.classList.toggle('hidden'); document.body.classList.toggle('overflow-hidden'); const isOpen = !mobileMenu.classList.contains('hidden'); menuIcon.setAttribute('data-lucide', isOpen ? 'x' : 'menu'); lucide.createIcons(); }); document.querySelectorAll('#mobile-menu a').forEach(link => { link.addEventListener('click', () => { mobileMenu.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); menuIcon.setAttribute('data-lucide', 'menu'); lucide.createIcons(); }); }); } }

        // --- Supabase & Gallery Logic ---
        // REPLACE WITH YOUR ACTUAL SUPABASE KEYS
        const SUPABASE_URL = 'https://gswdqdsviqrzsoahxapc.supabase.co/'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdzd2RxZHN2aXFyenNvYWh4YXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODM5NzcsImV4cCI6MjA3NjQ1OTk3N30.JFF6NFIdqZAE9ioHeMdfIVpN84UtN_Z0K2pZYodlpZY';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const galleryContainer = document.getElementById('gallery-container');
        const loadingMessage = document.getElementById('loading-message');
        const defaultPlaceholder = 'https://placehold.co/800x600/1c1917/f59e0b?text=MEDIA';

        // Lightbox elements
        const lightboxModal = document.getElementById('lightbox-modal');
        const lightboxMediaContent = document.getElementById('lightbox-media-content');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const lightboxClose = document.getElementById('lightbox-close');

        function isVideoUrl(url) {
            if (!url) return false;
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv'];
            const lowerUrl = url.toLowerCase();
            return videoExtensions.some(ext => lowerUrl.endsWith(ext));
        }

        // --- Video Thumbnail Generation Function (Copied from working implementation) ---
        async function generateVideoThumbnail(videoUrl) {
            console.log(`Attempting thumbnail for: ${videoUrl}`); // Log start
            return new Promise((resolve) => {
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                let resolved = false;

                video.classList.add('thumbnail-generator-video'); // Apply hidden style
                video.muted = true; video.playsInline = true; video.preload = 'metadata'; video.crossOrigin = 'anonymous';

                const onError = (e) => { if (resolved) return; console.warn(`Thumb gen failed for ${videoUrl}:`, (e.type || 'Error'), e); cleanup(); resolve(null); };
                const cleanup = () => { video.removeEventListener('loadeddata', onLoadedData); video.removeEventListener('seeked', onSeeked); video.removeEventListener('error', onError); video.removeEventListener('stalled', onError); video.removeEventListener('abort', onError); clearTimeout(timeoutId); if (video.parentNode === document.body) document.body.removeChild(video); };
                const timeoutId = setTimeout(() => { if (resolved) return; console.warn(`Thumb gen timed out for ${videoUrl}`); cleanup(); resolve(null); }, 10000); // 10 sec timeout

                const onLoadedData = () => { if (!video.videoWidth || !video.videoHeight) { console.warn(`Invalid dimensions for ${videoUrl}`); cleanup(); resolve(null); return; } canvas.width = video.videoWidth; canvas.height = video.videoHeight; video.currentTime = Math.min(1, (video.duration || 1) / 2); };
                const onSeeked = () => { if (resolved) return; setTimeout(() => { if (resolved) return; try { context.drawImage(video, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); resolved = true; cleanup(); resolve(dataUrl); } catch (drawError) { onError(drawError); } }, 150); }; // Delay draw

                video.addEventListener('loadeddata', onLoadedData); video.addEventListener('seeked', onSeeked); video.addEventListener('error', onError); video.addEventListener('stalled', onError); video.addEventListener('abort', onError);
                video.src = videoUrl;
                document.body.appendChild(video); // Add to body to ensure loading
                video.load();
            });
        }


        async function loadGallery() {
            try {
                // Keep the loading message visible
                if(loadingMessage) loadingMessage.textContent = 'Loading gallery data...';

                const { data, error } = await _supabase
                    .from('galleryImages') // Use the correct table name
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                galleryContainer.innerHTML = ''; // Clear only before processing data

                if (!data || data.length === 0) { // Check for null or empty array
                    galleryContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Gallery is empty.</p>';
                    if(loadingMessage) loadingMessage.remove(); // Remove loading msg if empty
                    initializeFilter(); // Still init filter
                    return;
                }

                 if(loadingMessage) loadingMessage.textContent = 'Generating video thumbnails (may take time)...'; // Update status

                // Use Promise.all to map data and handle async thumbnail generation
                const itemPromises = data.map(async (item) => {
                    const isVideo = item.category === 'video' || (item.category !== 'photo' && isVideoUrl(item.imageUrl));
                    const itemCategory = isVideo ? 'video' : 'photo';
                    let previewSrc = defaultPlaceholder;

                    if (isVideo && item.imageUrl) {
                        // --- Generate Thumbnail ---
                        const thumbnailUrl = await generateVideoThumbnail(item.imageUrl);
                        previewSrc = thumbnailUrl || defaultPlaceholder; // Use generated or fallback
                    } else if (!isVideo && item.imageUrl) {
                        previewSrc = item.imageUrl; // Use actual image URL
                    }

                    // Return the HTML for the gallery item
                    return `
                        <div class="gallery-item group relative overflow-hidden rounded-lg aspect-[4/3] cursor-pointer bg-gray-800"
                             data-category="${itemCategory}"
                             data-src="${item.imageUrl || ''}"
                             data-title="${item.title || 'Gallery Item'}"
                             data-is-video="${isVideo}">
                            <img src="${previewSrc}"
                                 alt="Preview: ${item.title || 'Gallery item'}"
                                 onerror="this.onerror=null;this.src='${defaultPlaceholder}';"
                                 class="absolute inset-0 w-full h-full object-cover transition duration-500 group-hover:scale-105">
                            ${isVideo ? `
                                <div class="video-overlay-icon">
                                    <svg data-lucide="play"></svg> <!-- Use Lucide icon -->
                                </div>
                            ` : ''}
                            <div class="absolute inset-0 bg-black bg-opacity-30 group-hover:bg-opacity-50 transition duration-300"></div>
                            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/70 to-transparent pt-10">
                                <span class="text-xs text-yellow-500 uppercase tracking-widest">${itemCategory}</span>
                                <h3 class="text-lg font-bold text-white oswald truncate">${item.title || 'Untitled'}</h3>
                            </div>
                        </div>
                    `;
                });

                // Wait for all promises (including thumbnail generation) to resolve
                const galleryHTMLArray = await Promise.all(itemPromises);
                galleryContainer.innerHTML = galleryHTMLArray.join(''); // Set the final HTML
                 if(loadingMessage) loadingMessage.remove(); // Remove status message after success

                initializeFilter(); // Setup filter buttons
                initializeLightbox(); // Setup lightbox clicks
                lucide.createIcons(); // Render any icons (like video overlay)

            } catch (error) {
                console.error("Error loading gallery:", error);
                 if(loadingMessage) loadingMessage.remove(); // Remove loading msg on error
                galleryContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Could not load gallery: ${error.message}</p>`;
            }
        }

        // --- Filter Logic ---
        function initializeFilter() {
            const filterButtons = document.querySelectorAll('#filter-buttons .filter-btn');
            const galleryItems = document.querySelectorAll('#gallery-container .gallery-item');
             // Check if galleryItems exists AND has length > 0
            if ((!galleryItems || galleryItems.length === 0) && filterButtons.length > 0) {
                 if (!filterButtons[0].classList.contains('active')) { /* ... ensure 'All' active style ... */ }
                 filterButtons.forEach((btn, index) => { if (index !== 0 && !btn.classList.contains('bg-gray-800')) { /* ... ensure inactive styles ... */ }});
                 return;
             }
            const activeClasses = ['bg-yellow-500', 'text-black'];
            const inactiveClasses = ['bg-gray-800', 'text-gray-400', 'hover:bg-gray-700', 'hover:text-white'];
            filterButtons.forEach(button => {
                 if (!button.classList.contains('active')) button.classList.add(...inactiveClasses); else button.classList.add(...activeClasses);
                button.addEventListener('click', () => {
                     const filterValue = button.getAttribute('data-filter');
                    filterButtons.forEach(btn => { btn.classList.remove(...activeClasses); btn.classList.add(...inactiveClasses); });
                    button.classList.remove(...inactiveClasses); button.classList.add(...activeClasses);
                     // Check galleryItems exists before iterating
                     if(galleryItems) { galleryItems.forEach(item => { const itemCategory = item.getAttribute('data-category'); item.classList.toggle('hidden', !(filterValue === 'all' || itemCategory === filterValue)); }); }
                 });
            });
             const initialFilter = document.querySelector('#filter-buttons .filter-btn.active')?.dataset.filter || 'all';
             // Check galleryItems exists before filtering
             if (galleryItems && galleryItems.length > 0) { galleryItems.forEach(item => { const itemCategory = item.getAttribute('data-category'); item.classList.toggle('hidden', !(initialFilter === 'all' || itemCategory === initialFilter)); }); }
        }

        // --- Lightbox Logic ---
        function initializeLightbox() {
             galleryContainer.addEventListener('click', function(e) {
                 const galleryItem = e.target.closest('.gallery-item');
                 if (galleryItem) {
                     const src = galleryItem.dataset.src;
                     const title = galleryItem.dataset.title;
                     const isVideo = galleryItem.dataset.isVideo === 'true';

                     if (!src) { console.warn("No src found for gallery item."); return; }

                     let mediaElementHTML = '';
                     if (isVideo) {
                         mediaElementHTML = `<video src="${src}" controls autoplay loop class="lightbox-content" preload="auto">Video not supported.</video>`;
                     } else {
                         mediaElementHTML = `<img src="${src}" alt="${title}" class="lightbox-content">`;
                     }

                     lightboxMediaContent.innerHTML = mediaElementHTML;
                     lightboxCaption.textContent = title;
                     lightboxModal.style.display = "flex"; // Use flex for centering
                     document.body.style.overflow = 'hidden'; // Prevent background scroll
                 }
             });

             // Close lightbox events
             lightboxClose.addEventListener('click', closeLightbox);
             lightboxModal.addEventListener('click', function(e) { if (e.target === lightboxModal) { closeLightbox(); } });
             document.addEventListener('keydown', function(e) { if (e.key === "Escape" && lightboxModal.style.display === "flex") { closeLightbox(); } });
        }
        function closeLightbox() {
             lightboxModal.style.display = "none";
             const mediaElement = lightboxMediaContent.querySelector('video, audio');
             if (mediaElement) {
                 mediaElement.pause();
                 mediaElement.currentTime = 0;
             }
             lightboxMediaContent.innerHTML = ''; // Clear content
             lightboxCaption.textContent = '';
             document.body.style.overflow = ''; // Restore scrolling
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadGallery);

    </script>
</body>
</html>

