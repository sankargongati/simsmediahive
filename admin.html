<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | SIMS Media Hive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include the Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d0d0d; color: #f3f4f6; }
        .oswald { font-family: 'Oswald', sans-serif; }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white oswald tracking-wider">Admin Panel</h1>
            <button id="logout-button" class="px-4 py-2 text-sm font-semibold bg-red-600 text-white rounded-md hover:bg-red-700 transition">Logout</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Upload Form Section -->
        <section class="bg-gray-900 p-8 rounded-lg border border-gray-800 mb-12">
            <h2 class="text-2xl font-bold text-yellow-500 oswald mb-6">Add New Gallery Item</h2>
            <form id="upload-form" class="space-y-6">
                <div>
                    <label for="image-title" class="block text-sm font-medium text-gray-300 mb-2">Image Title</label>
                    <input type="text" id="image-title" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center"><input type="radio" name="category" value="photo" checked class="text-yellow-500 focus:ring-yellow-500"> <span class="ml-2">Photo</span></label>
                        <label class="flex items-center"><input type="radio" name="category" value="video" class="text-yellow-500 focus:ring-yellow-500"> <span class="ml-2">Video</span></label>
                    </div>
                </div>
                <div>
                    <label for="image-file" class="block text-sm font-medium text-gray-300 mb-2">Image File</label>
                    <input type="file" id="image-file" accept="image/*" required class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-black hover:file:bg-yellow-600">
                </div>
                <div>
                    <button type="submit" class="w-full py-3 px-4 font-semibold text-black bg-yellow-500 rounded-md hover:bg-yellow-600 transition disabled:bg-gray-500">Upload Image</button>
                </div>
                <div id="upload-status" class="text-center text-sm h-5"></div>
            </form>
        </section>

        <!-- Existing Images Section -->
        <section>
            <h2 class="text-2xl font-bold text-yellow-500 oswald mb-6">Manage Gallery</h2>
            <div id="image-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Images will be loaded here by JavaScript -->
            </div>
        </section>
    </main>
    
    <script type="module">
        // --- CONFIGURATION ---
        // PASTE YOUR KEYS FROM THE SUPABASE DASHBOARD HERE
        const SUPABASE_URL = 'https://gswdqdsviqrzsoahxapc.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdzd2RxZHN2aXFyenNvYWh4YXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODM5NzcsImV4cCI6MjA3NjQ1OTk3N30.JFF6NFIdqZAE9ioHeMdfIVpN84UtN_Z0K2pZYodlpZY';

        // --- CRITICAL STEP ---
        // THIS NAME MUST EXACTLY MATCH THE BUCKET NAME IN YOUR SUPABASE STORAGE DASHBOARD.
        const BUCKET_NAME = 'gallery-images'; 

        // --- INITIALIZATION ---
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const uploadForm = document.getElementById('upload-form');
        const imageList = document.getElementById('image-list');
        const uploadStatus = document.getElementById('upload-status');
        const logoutButton = document.getElementById('logout-button');
        const submitButton = document.querySelector('#upload-form button[type="submit"]');

        // --- AUTHENTICATION ---
        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = '/login.html'; 
            } else {
                loadImages();
            }
        }

        logoutButton.addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.href = '/login.html';
        });

        // --- DATABASE & STORAGE INTERACTIONS ---

        async function loadImages() {
            imageList.innerHTML = '<p class="text-gray-400 col-span-full text-center">Loading images...</p>';
            const { data, error } = await _supabase.from('galleryImages').select('*').order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching images:', error);
                imageList.innerHTML = `<p class="text-red-500 col-span-full text-center">Could not fetch images: ${error.message}</p>`;
                return;
            }

            imageList.innerHTML = '';
            if (data.length === 0) {
                imageList.innerHTML = '<p class="text-gray-400 col-span-full text-center">No images in the gallery yet. Upload one above!</p>';
            } else {
                data.forEach(imageData => {
                    const filePath = new URL(imageData.imageUrl).pathname.split(`/${BUCKET_NAME}/`)[1];
                    const imageCard = `
                        <div class="relative group bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
                            <img src="${imageData.imageUrl}" alt="${imageData.title}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <p class="font-bold text-white truncate">${imageData.title}</p>
                                <p class="text-sm text-gray-400 capitalize">${imageData.category}</p>
                            </div>
                            <button data-id="${imageData.id}" data-path="${filePath}" class="delete-btn absolute top-2 right-2 p-1.5 bg-red-600 text-white rounded-full hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity" title="Delete Image">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>`;
                    imageList.insertAdjacentHTML('beforeend', imageCard);
                });
            }
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Uploading...';
            uploadStatus.textContent = 'Starting upload...';
            uploadStatus.style.color = 'white';

            const title = document.getElementById('image-title').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            const file = document.getElementById('image-file').files[0];
            
            if (!file) {
                uploadStatus.textContent = 'Please select a file.';
                uploadStatus.style.color = 'red';
                submitButton.disabled = false;
                submitButton.textContent = 'Upload Image';
                return;
            }

            const fileExt = file.name.split('.').pop();
            const filePath = `${Date.now()}.${fileExt}`;

            try {
                // Step A: Upload file to Supabase Storage
                uploadStatus.textContent = 'Uploading file to storage...';
                const { error: uploadError } = await _supabase.storage.from(BUCKET_NAME).upload(filePath, file);
                if (uploadError) throw uploadError;

                // Step B: Get public URL for the file
                const { data: urlData } = _supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
                
                // Step C: Save metadata to the database
                uploadStatus.textContent = 'Saving details to database...';
                const { error: dbError } = await _supabase.from('galleryImages').insert([{ title, category, imageUrl: urlData.publicUrl }]);
                if (dbError) throw dbError;

                uploadStatus.textContent = 'Upload successful!';
                uploadStatus.style.color = '#22c55e';
                uploadForm.reset();
                await loadImages();

            } catch (error) {
                console.error("Upload process failed:", error);
                uploadStatus.textContent = `Error: ${error.message}`;
                uploadStatus.style.color = '#ef4444';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Upload Image';
            }
        });

        imageList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const docId = deleteButton.dataset.id;
                const filePath = deleteButton.dataset.path;

                if (confirm('Are you sure you want to permanently delete this image?')) {
                    try {
                        // Step A: Delete file from Supabase Storage
                        const { error: storageError } = await _supabase.storage.from(BUCKET_NAME).remove([filePath]);
                        if (storageError) throw storageError;
                        
                        // Step B: Delete record from the database
                        const { error: dbError } = await _supabase.from('galleryImages').delete().eq('id', docId);
                        if (dbError) throw dbError;

                        alert('Image deleted successfully!');
                        await loadImages();
                    } catch (error) {
                        alert(`Deletion failed: ${error.message}`);
                        console.error("Deletion process failed:", error);
                    }
                }
            }
        });

        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
